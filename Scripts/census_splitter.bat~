@echo off

REM CD to working directory
cd %userprofile%\Documents\Moodle_Miner_2.0

REM Make New Folders if not Already Made
if not exist "Activity_Reports" mkdir Activity_Reports
if not exist "Cookies" mkdir Cookies
if not exist "Downloaded_Logs" mkdir Downloaded_Logs
if not exist "Text" mkdir Text
if not exist "Course_Numbers" mkdir Course_Numbers
if not exist "%userprofile%\Documents\Activity_Reports" mkdir %userprofile%\Documents\Activity_Reports

REM Delete Contents of Old Folders
if exist "Activity_Reports" del /f /s /q Activity_Reports 1>nul
if exist "Cookies" del /f /s /q Cookies 1>nul
if exist "Downloaded_Logs" del /f /s /q Downloaded_Logs 1>nul
if exist "Text" del /f /s /q Text 1>nul
if exist "Course_Numbers" del /f /s /q Course_Numbers 1>nul
if exist "%userprofile%\Documents\Activity_Reports" del /f /s /q "%userprofile%\Documents\Activity_Reports" 1>nul



REM Wowrking
set arg1=%1
set arg2=%2
set arg3=%3
shift
shift
shift

REM Full Name Setup
@echo %arg3% > "Instructor.txt"


REM wget setup for cookies

call WinWGetPortable\App\WinWget\wget\wget.exe --user-agent="Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.6) Gecko/20040113" --keep-session-cookies --save-cookies=Cookies\cookies.txt --post-data="username=%arg1%&password=%arg2%" --delete-after "https://online.surry.edu/login/index.php"


REM Get Course Numbers %2 is getting passed to the url. 

REM BIO Courses
Start "" WinWGetPortable\App\WinWget\wget\wget.exe --load-cookies=Cookies/cookies.txt --user-agent="Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.6) Gecko/20040113" -O Course_Numbers\Bio_Courses --header="Referer: http://online.surry.edu" "http://online.surry.edu/course/search.php?search=2017FA%%20Bio&perpage=all"

REM CHM Courses
WinWGetPortable\App\WinWget\wget\wget.exe --load-cookies=Cookies/cookies.txt --user-agent="Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.6) Gecko/20040113" -O Course_Numbers\Chm_Courses --header="Referer: http://online.surry.edu" "http://online.surry.edu/course/search.php?search=2017FA%%20Chm&perpage=all"

REM PED Courses
WinWGetPortable\App\WinWget\wget\wget.exe --load-cookies=Cookies/cookies.txt --user-agent="Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.6) Gecko/20040113" -O Course_Numbers\Ped_Courses --header="Referer: http://online.surry.edu" "http://online.surry.edu/course/search.php?search=2017FA%%20Ped&perpage=all"

REM HEA Courses
WinWGetPortable\App\WinWget\wget\wget.exe --load-cookies=Cookies/cookies.txt --user-agent="Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.6) Gecko/20040113" -O Course_Numbers\Hea_Courses --header="Referer: http://online.surry.edu" "http://online.surry.edu/course/search.php?search=2017FA%%20Hea&perpage=all"

REM HOR Courses
WinWGetPortable\App\WinWget\wget\wget.exe --load-cookies=Cookies/cookies.txt --user-agent="Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.6) Gecko/20040113" -O Course_Numbers\Hor_Courses --header="Referer: http://online.surry.edu" "http://online.surry.edu/course/search.php?search=2017FA%%20Hor&perpage=all"

REM AGR Courses
WinWGetPortable\App\WinWget\wget\wget.exe --load-cookies=Cookies/cookies.txt --user-agent="Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.6) Gecko/20040113" -O Course_Numbers\Agr_Courses --header="Referer: http://online.surry.edu" "http://online.surry.edu/course/search.php?search=2017FA%%20Agr&perpage=all"

REM VEN Courses
WinWGetPortable\App\WinWget\wget\wget.exe --load-cookies=Cookies/cookies.txt --user-agent="Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.6) Gecko/20040113" -O Course_Numbers\Ven_Courses --header="Referer: http://online.surry.edu" "http://online.surry.edu/course/search.php?search=2017FA%%20Ven&perpage=all"

endlocal

REM Run R-Script to mine for course numbers from downloaded logs
call R-Portable\App\R-Portable\bin\Rscript.exe Scripts\instructor_course_number_miner.R course_numbers.txt



REM Read Course numbers (from text file) into an array
setlocal EnableDelayedExpansion

set i=0
for /F %%a in (course_numbers.txt) do (
    set /A i+=1
    set course_array[!i!]=%%a
)
set n=%i%


REM wget based on for loop from source file

for /L %%i in (1,1,%n%) do call WinWGetPortable\App\WinWget\wget\wget.exe --user-agent="Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.6) Gecko/20040113" --post-data="download=csv" --load-cookies=Cookies\cookies.txt -O Downloaded_Logs\!course_array[%%i]!_Report.csv --header="Referer: http://online.surry.edu" "http://online.surry.edu/report/log/index.php?chooselog=1&showusers=0&showcourses=0&id=!course_array[%%i]!&group=&user=&date=&modid=&modaction=&edulevel=-1&logreader=logstore_standard"

REM Run R-Script to Analyze Downloaded Reports based on for loop from array
for /L %%i in (1,1,%n%) do call R-Portable\App\R-Portable\bin\Rscript.exe Scripts\activity_analysis.R Downloaded_Logs\!course_array[%%i]!_Report.csv Activity_Reports\!course_array[%%i]!_Activity_Report.csv

REM Copy Activity Reports to Desktop
xcopy /s Activity_Reports %userprofile%\Documents\Activity_Reports


REM Notification Message Box using VBS Script
call cscript Scripts/Notification.vbs && exit




REM  ------------------------------------------------------------------------------
REM   Masks user input and returns the input as a variable.
REM   Password-masking code based on http://www.dostips.com/forum/viewtopic.php?p=33538#p33538
REM  
REM   Arguments: %1 - the variable to store the password in
REM              %2 - the prompt to display when receiving input
REM  ------------------------------------------------------------------------------
:getPassword
set "_password="

REM   We need a backspace to handle character REM  oval
for /f %%a in ('"prompt;$H&for %%b in (0) do REM  "') do set "BS=%%a"

REM   Prompt the user
set /p "=%~2" <nul

:keyLoop
REM   Retrieve a keypress
set "key="
for /f "delims=" %%a in ('xcopy /l /w "%~f0" "%~f0" 2^>nul') do if not defined key set "key=%%a"
set "key=%key:~-1%"

REM   If No keypress (enter), then exit
REM   If backspace, REM  ove character from password and console
REM   Otherwise, add a character to password and go ask for next one
if defined key (
    if "%key%"=="%BS%" (
        if defined _password (
            set "_password=%_password:~0,-1%"
            set /p "=!BS! !BS!"<nul
        )
    ) else (
        set "_password=%_password%%key%"
        set /p "="<nul
    )
    goto :keyLoop
)
echo/

REM   Return password to caller
set "%~1=%_password%"
goto :eof






